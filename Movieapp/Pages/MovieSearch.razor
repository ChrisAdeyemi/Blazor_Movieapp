@page "/movies"
@using Movieapp.Models  
@inject NavigationManager Navigation
<h3>Search for Movies</h3>


<div class="search-container">
    <div class="filter-container">
        <select @bind="SelectedType" class="filter-select">
            <option value="">All</option>
            <option value="movie">Movies</option>
            <option value="series">TV Shows</option>
        </select>
    </div>
    <div class="search-box">
        <input @bind="SearchText" placeholder="Search movies..." class="search-input" />
    </div>
    <button @onclick="SearchMovies" class="search-button">Search</button>
</div>



@if (IsLoading)
{
    <p>Loading...</p>
}

@if (ErrorMessage != null)
{
    <p style="color:red">@ErrorMessage</p>
}

@if (Movies != null)
{
    <div style="display:flex; flex-wrap:wrap;">
        @foreach (var movie in Movies)
        {
            <div style="margin:10px; width:150px;">
                <img src="@movie.Poster" width="150"
                     style="cursor:pointer"
                     @onclick="() => OpenMovieDetails(movie.imdbID)" />

                <p>@movie.Title (@movie.Year)</p>
            </div>
        }
    </div>
}

@code {
    private string SelectedType = "";
    private string SearchText = "";
    private bool IsLoading = false;
    private string? ErrorMessage;
    private List<MovieSummary>? Movies;

    private readonly string[] popularMovies = new[]
    {
    "Avengers","Iron Man","Black Panther","Guardians of the Galaxy","Inception","The Matrix","Interstellar","Joker","Mad Max: Fury Road","Star Wars: The Force Awakens",
    "Spider-Man: No Way Home","Wonder Woman","Thor: Ragnarok","Captain America: Civil War","Doctor Strange","Aquaman","Deadpool","Ant-Man","Batman Begins","The Dark Knight",
    "Frozen","Zootopia","Toy Story","Minions","Shrek","Finding Nemo","Moana","The Incredibles","Despicable Me","Coco","Aladdin","Beauty and the Beast","Inside Out","Tangled",
    "Mulan","Raya and the Last Dragon","Kung Fu Panda","How to Train Your Dragon","The Lion King","Monsters, Inc.","Titanic","The Godfather","Forrest Gump","La La Land",
    "Jurassic Park","Avatar","Harry Potter and the Sorcerer's Stone","The Lord of the Rings: The Fellowship of the Ring","Gladiator","Pirates of the Caribbean: The Curse of the Black Pearl"
    };

    protected override async Task OnInitializedAsync()
    {
        Movies = new List<MovieSummary>();
        IsLoading = true;

        try
        {
            using var http = new HttpClient();
            string apiKey = "c87d23ca";

            foreach (var title in popularMovies)
            {
                string url = $"https://www.omdbapi.com/?apikey={apiKey}&t={Uri.EscapeDataString(title)}";
                var movie = await http.GetFromJsonAsync<MovieSummary>(url);

                if (movie != null && movie.Response != "False")
                    Movies.Add(movie);
            }
        }
        catch
        {
            ErrorMessage = "Error loading popular movies.";
        }

        IsLoading = false;
    }

    private async Task SearchMovies()
    {
        ErrorMessage = null;

        if (string.IsNullOrWhiteSpace(SearchText))
        {
            ErrorMessage = "Please enter a movie name.";
            return;
        }

        IsLoading = true;

        try
        {
            using var http = new HttpClient();
            string apiKey = "c87d23ca";

            string url = $"https://www.omdbapi.com/?apikey={apiKey}&s={SearchText}";

            if (!string.IsNullOrEmpty(SelectedType))
                url += $"&type={SelectedType}";


            var response = await http.GetFromJsonAsync<OmdbSearchResponse>(url);

            if (response?.Search != null)
            {
                Movies = response.Search.ToList();
            }
            else
            {
                ErrorMessage = "No results found.";
                Movies = new List<MovieSummary>();
            }
        }
        catch
        {
            ErrorMessage = "Error contacting OMDb API.";
        }

        IsLoading = false;
    }

    void OpenMovieDetails(string imdbID)
    {
        Navigation.NavigateTo($"/movie/{imdbID}");
    }
}
